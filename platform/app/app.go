// Code generated by dol build. Only Generate by tools if not existed.
// source: app.go

package app

import (
	"context"
	"fmt"
	"net"
	"net/http"
	"path"

	"github.com/json-iterator/go/extra"
	"github.com/sirupsen/logrus"
	"github.com/spf13/viper"

	// github.com/2637309949/dolphin/platform/conf
	_ "github.com/2637309949/dolphin/platform/conf"
	"github.com/2637309949/dolphin/platform/util"
)

// OnStart defined OnStart
func OnStart(engine *Engine, httpSrv *http.Server, rpcSrv net.Listener) func(context.Context) error {
	return func(context.Context) error {
		logrus.Infof("http listen on port:%v", viper.GetString("http.port"))
		logrus.Infof("grpc listen on port:%v", viper.GetString("grpc.port"))
		httpSrv.Handler = engine.Gin
		go func() {
			if err := httpSrv.ListenAndServe(); err != nil {
				logrus.Fatal(err)
			}
		}()
		go func() {
			if err := engine.GRPC.Serve(rpcSrv); err != nil {
				logrus.Fatal(err)
			}
		}()
		return nil
	}
}

// OnStop defined OnStop
func OnStop(e *Engine, httpSrv *http.Server, rpcSrv net.Listener) func(ctx context.Context) error {
	return func(ctx context.Context) error {
		if err := httpSrv.Shutdown(ctx); err != nil {
			logrus.Fatal(err)
			return err
		}
		if err := rpcSrv.Close(); err != nil {
			logrus.Fatal(err)
			return err
		}
		return nil
	}
}

// NewLifeHook create lifecycle hook
func NewLifeHook(e *Engine) Hook {
	httpSrv, rpcSrv := &http.Server{Addr: fmt.Sprintf(":%v", viper.GetString("http.port"))}, util.EnsureLeft(net.Listen("tcp", fmt.Sprintf(":%v", viper.GetString("grpc.port")))).(net.Listener)
	return Hook{OnStart(e, httpSrv, rpcSrv), OnStop(e, httpSrv, rpcSrv)}
}

// init after NewEngine
func init() {
	extra.RegisterFuzzyDecoders()
	AuthServerURL = viper.GetString("oauth.server")
	OA2Cfg.ClientID = viper.GetString("oauth.id")
	OA2Cfg.ClientSecret = viper.GetString("oauth.secret")
	OA2Cfg.RedirectURL = viper.GetString("oauth.cli") + path.Join(viper.GetString("http.prefix"), SysCasInstance.Oauth2.RelativePath)
	OA2Cfg.Endpoint.AuthURL = AuthServerURL + path.Join(viper.GetString("http.prefix"), SysCasInstance.Authorize.RelativePath)
	OA2Cfg.Endpoint.TokenURL = AuthServerURL + path.Join(viper.GetString("http.prefix"), SysCasInstance.Token.RelativePath)
	SyncModel()
	SyncController()
	SyncService()
}
